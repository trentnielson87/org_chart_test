<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Collapsible Org Chart with Tooltips & Disconnected Nodes</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; }
  .node rect { fill: #fff; stroke: steelblue; stroke-width: 2px; rx: 6px; ry: 6px; }
  .node text { font: 12px sans-serif; pointer-events: none; }
  .node image { pointer-events: none; }
  .link { fill: none; stroke: #ccc; stroke-width: 2px; }
  svg { width: 100%; height: 90vh; overflow: visible; }
  #controls { margin: 10px 20px; }
</style>
</head>
<body>
<div id="controls">
  <button id="toggleExpand">Toggle Expand All</button>
</div>
<h2 style="margin-left:20px;">Collapsible Org Chart with Tooltips & Disconnected Nodes</h2>
<svg></svg>

<script>
const sheetId = "1xZAsHK_U8BajMe2d2pMEkSvQnrV2t7Ds08v_YeKgVAQ";
const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

let allRoots = [];
let expandAll = false;
const svg = d3.select("svg");
const g = svg.append("g").attr("transform", "translate(80,40)");

const NODE_WIDTH = 140;
const NODE_HEIGHT = 50;
const VERTICAL_MARGIN = 80;
const MAX_PHOTO_SIZE = 60;

// Fetch data
fetch(url)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
    const rows = json.table.rows;

    const data = rows.slice(1).map(r => ({
      manager: r.c[0]?.v?.toString().trim() ?? null,
      employee: r.c[1]?.v?.toString().trim() ?? null,
      title: r.c[2]?.v?.toString().trim() ?? "",
      photo: r.c[3]?.v?.toString().trim() ?? ""
    }));

    buildForest(data);
    drawForest();
  })
  .catch(err => console.error(err));

function buildForest(pairs) {
  const nodes = {};
  const childrenSet = new Set();

  // create nodes for all managers and employees
  pairs.forEach(({manager, employee, title, photo}) => {
    if(manager && !nodes[manager]) nodes[manager] = { name: manager, title:"", photo:"", children: [] };
    if(employee && !nodes[employee]) nodes[employee] = { name: employee, title, photo, children: [] };
    childrenSet.add(employee);
  });

  // assign children
  pairs.forEach(({manager, employee}) => {
    if(manager && employee) nodes[manager].children.push(nodes[employee]);
  });

  // roots = nodes that are never children
  allRoots = Object.values(nodes).filter(n => !childrenSet.has(n.name));
}

function drawForest() {
  g.selectAll("*").remove();
  const [treeHeight, treeWidth] = [window.innerHeight - NODE_HEIGHT - VERTICAL_MARGIN, window.innerWidth - NODE_WIDTH - 40];
  const tree = d3.tree().nodeSize([NODE_HEIGHT + 60, NODE_WIDTH + 60]).size([treeHeight, treeWidth]);

  let yOffset = 0;
  allRoots.forEach(rootData => {
    const root = d3.hierarchy(rootData);
    root.x0 = 0; root.y0 = 0;

    if(!expandAll && root.children) root.children.forEach(collapse);

    update(root, yOffset);
    yOffset += (root.height + 1) * (NODE_HEIGHT + 60) + VERTICAL_MARGIN;
  });

  function collapse(d) {
    if(d.children){ d._children = d.children; d._children.forEach(collapse); d.children=null; }
  }

  function truncateText(str, maxWidth, fontSize = 12) {
    const ellipsis = "...";
    const approxCharWidth = fontSize * 0.6;
    const maxChars = Math.floor(maxWidth / approxCharWidth);
    if(str.length > maxChars) return str.slice(0, maxChars - ellipsis.length) + ellipsis;
    return str;
  }

  function update(source, offsetY) {
    tree(source);

    const link = g.selectAll(".link").data(source.links(), d=>d.target.data.name);
    link.enter().append("path")
      .attr("class","link")
      .merge(link)
      .attr("d", d => {
        const startX = d.source.y + NODE_WIDTH/2;
        const startY = d.source.x + offsetY;
        const endX = d.target.y - NODE_WIDTH/2;
        const endY = d.target.x + offsetY;
        return `M${startX},${startY} C${(startX+endX)/2},${startY} ${(startX+endX)/2},${endY} ${endX},${endY}`;
      });
    link.exit().remove();

    const node = g.selectAll(".node").data(source.descendants(), d=>d.data.name);
    const nodeEnter = node.enter().append("g")
      .attr("class","node")
      .attr("transform", d=>`translate(${source.y0},${source.x0 + offsetY})`)
      .attr("title", d => `${d.data.name} - ${d.data.title}`) // tooltip on group
      .on("click", (event,d)=>{ 
        if(d.children){ d._children=d.children; d.children=null;} 
        else {d.children=d._children; d._children=null;} 
        update(source, offsetY);
      });

    nodeEnter.append("rect")
      .attr("width", NODE_WIDTH)
      .attr("height", NODE_HEIGHT)
      .attr("x",-NODE_WIDTH/2)
      .attr("y",-NODE_HEIGHT/2)
      .attr("fill","#fff")
      .attr("stroke","steelblue")
      .attr("stroke-width",2)
      .attr("rx",6)
      .attr("ry",6);

    nodeEnter.filter(d => d.data.photo)
      .append("image")
      .attr("xlink:href", d => d.data.photo)
      .attr("width", d => Math.min(MAX_PHOTO_SIZE, NODE_WIDTH*0.9))
      .attr("height", d => Math.min(MAX_PHOTO_SIZE, NODE_HEIGHT*1.8))
      .attr("x", d => -Math.min(MAX_PHOTO_SIZE, NODE_WIDTH*0.9)/2)
      .attr("y", d => -NODE_HEIGHT/2 - Math.min(MAX_PHOTO_SIZE, NODE_HEIGHT*1.8) - 5)
      .attr("clip-path","circle(50%)");

    nodeEnter.append("text")
      .attr("x",0).attr("y",-2)
      .attr("text-anchor","middle")
      .text(d => truncateText(d.data.name, NODE_WIDTH-10));

    nodeEnter.append("text")
      .attr("x",0).attr("y",14)
      .attr("text-anchor","middle")
      .attr("font-size","10px")
      .attr("fill","#555")
      .text(d => truncateText(d.data.title, NODE_WIDTH-10, 10));

    const nodeUpdate = nodeEnter.merge(node);
    nodeUpdate.transition().duration(300).attr("transform", d=>`translate(${d.y},${d.x + offsetY})`);
    node.exit().remove();

    source.descendants().forEach(d=>{ d.x0=d.x; d.y0=d.y; });
  }
}

document.getElementById("toggleExpand").addEventListener("click", () => {
  expandAll = !expandAll;
  drawForest();
});

window.addEventListener("resize", () => {
  if (allRoots.length === 0) return;
  drawForest();
});
</script>
</body>
</html>
